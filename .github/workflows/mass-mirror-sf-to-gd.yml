name: Mass Mirror (Random Shuffle Mirror)
on:
  workflow_dispatch:
    inputs:
      folder_id:
        description: 'Google Drive Folder ID tujuan'
        required: true

jobs:
  random-mirror:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl unzip
          curl https://rclone.org/install.sh | sudo bash

      - name: 3. Proses Mirroring
        shell: bash
        env:
          RAW_CID: ${{ secrets.GDRIVE_CLIENT_ID }}
          RAW_SEC: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          RAW_TOK: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          FOLDER_ID: ${{ inputs.folder_id }}
        run: |
          CL_ID=$(echo "$RAW_CID" | tr -d '\n' | tr -d '\r' | xargs)
          CL_SEC=$(echo "$RAW_SEC" | tr -d '\n' | tr -d '\r' | xargs)
          R_TOK=$(echo "$RAW_TOK" | tr -d '\n' | tr -d '\r' | xargs)

          export RCLONE_CONFIG_MYDRIVE_TYPE=drive
          export RCLONE_CONFIG_MYDRIVE_CLIENT_ID="$CL_ID"
          export RCLONE_CONFIG_MYDRIVE_CLIENT_SECRET="$CL_SEC"
          export RCLONE_CONFIG_MYDRIVE_SCOPE=drive
          export RCLONE_CONFIG_MYDRIVE_TOKEN="{\"access_token\":\"\",\"token_type\":\"Bearer\",\"refresh_token\":\"$R_TOK\",\"expiry\":\"2023-01-01T00:00:00Z\"}"

          echo "‚úÖ Konfigurasi Rclone siap."
          
          if [ ! -f "url.txt" ]; then
            echo "‚ùå Error: File url.txt tidak ditemukan!"
            exit 1
          fi

          # User Agent
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/150.0.8220.52 Safari/537.36 Brave/4.0.2090.104"

          # --- POOL SERVER MIRROR ---
          BASE_MIRRORS=(
            "nchc"
            "sf-west-interserver-2.dl.sourceforge.net"
            "twds"
            "webwerks"
            "deac-riga"
            "altushost-swe"
            "psychz"
          )

          echo "üìÇ Memulai proses..."
          set +e 

          while IFS= read -r url || [ -n "$url" ]; do
            
            if [[ -z "$url" ]] || [[ "$url" == \#* ]]; then continue; fi
            url=$(echo "$url" | tr -d '\r')

            echo "==================================================="
            echo "‚û°Ô∏è Target: $url"

            # 1. Parsing Path
            temp_path="${url#*projects/}"
            temp_path="${temp_path//\/files\//\/}"
            temp_path="${temp_path%/download}"
            temp_path="${temp_path%\?*}"
            
            filename=$(basename "$temp_path")
            echo "üìÑ Nama File: $filename"

            download_success=false

            # --- LOGIKA PENGACAKAN (SHUFFLE) ---
            SHUFFLED_MIRRORS=($(shuf -e "${BASE_MIRRORS[@]}"))
            
            echo "üé≤ Urutan Mirror (Acak): ${SHUFFLED_MIRRORS[*]}"

            # 2. LOOPING MIRROR (Sesuai hasil acakan)
            for mirror in "${SHUFFLED_MIRRORS[@]}"; do
                echo "-----------------------------------"
                echo "üì° Mencoba Mirror: $mirror"
                
                # Construct URL
                if [[ "$mirror" == "autoselect" ]]; then
                   final_url="https://downloads.sourceforge.net/project/${temp_path}?use_mirror=autoselect"
                else
                   # Format direct mirror subdomain
                   final_url="https://${mirror}.dl.sourceforge.net/project/${temp_path}?viasf=1"
                fi
                
                # Download dengan aria2c
                aria2c -x 1 -s 1 -j 1 \
                  -c \
                  --min-split-size=1M \
                  --user-agent="$UA" \
                  --check-certificate=false \
                  --file-allocation=none \
                  --summary-interval=0 \
                  --connect-timeout=60 \
                  --max-tries=5 \
                  --retry-wait=3 \
                  --console-log-level=warn \
                  -o "$filename" "$final_url"

                # Cek File
                if [ -f "$filename" ]; then
                    filesize=$(stat -c%s "$filename")
                    # Validasi file > 1MB (bukan file HTML error)
                    if [ "$filesize" -gt 1000000 ]; then
                        echo "‚úÖ Download SUKSES dari $mirror."
                        download_success=true
                        break
                    else
                        # Hapus file sampah dan lanjut ke mirror berikutnya
                        rm -f "$filename"
                    fi
                fi
            done

            # 3. UPLOAD KE GDRIVE (Settingan Anti-Limit 429)
            if [ "$download_success" = true ]; then
                echo "‚¨ÜÔ∏è Uploading ke Google Drive..."
                
                rclone copy "$filename" mydrive: \
                  --drive-root-folder-id "$FOLDER_ID" \
                  --drive-chunk-size 128M \
                  --tpslimit 5 \
                  --checkers 2 \
                  --transfers 2 \
                  --user-agent "$UA" \
                  -v -P
                
                if [ $? -eq 0 ]; then
                    echo "‚úÖ Upload Selesai."
                    rm -f "$filename"
                else
                    echo "‚ùå Upload Gagal (Google Limit). Lanjut ke file berikutnya."
                    rm -f "$filename"
                fi
            else
                echo "‚ùå FATAL: Download gagal di semua mirror acak."
            fi
            
          done < url.txt

          echo "üéâ SELESAI SEMUA!"
